<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadastro - LicitHub</title>
    <link rel="stylesheet" href="css/login.css">
</head>
<body>
    <div class="login-container">
        <div class="login-box">
            <div class="logo-container">
                <h1>LicitHub</h1>
                <p style="color: var(--text-secondary);">Crie sua conta para participar</p>
            </div>
            <form id="register-form">
                <div class="input-group">
                    <label for="nome">Nome Completo</label>
                    <input type="text" id="nome" placeholder="Insira seu nome completo" required>
                </div>
                <div class="input-group">
                    <label for="email">Email</label>
                    <input type="email" id="email" placeholder="Insira seu email" required>
                </div>
                 <div class="input-group">
                    <label for="cpf">CPF</label>
                    <input type="text" id="cpf" placeholder="000.000.000-00" required>
                </div>
                <div class="input-group">
                    <label for="password">Senha</label>
                    <input type="password" id="password" placeholder="Crie uma senha forte" required>
                </div>
                <button type="submit" class="btn-login">Cadastrar</button>
            </form>
            <div id="error-message" class="error-message"></div>
            <p class="footer-text">Já tem uma conta? <a href="index.html">Faça login</a></p>
        </div>
    </div>

    <script src="js/database.js"></script>
    <script>
        document.getElementById('register-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const errorMessage = document.getElementById('error-message');
            const registerButton = e.target.querySelector('button');

            const userData = {
                nome: document.getElementById('nome').value,
                email: document.getElementById('email').value,
                cpf: document.getElementById('cpf').value,
                senha: document.getElementById('password').value,
                perfil: 'Usuário Padrão' // Perfil padrão para auto-cadastro
            };

            registerButton.textContent = 'Enviando...';
            registerButton.disabled = true;
            errorMessage.style.display = 'none';

            try {
                const result = await DB.registerUser(userData);

                // deve lançar um erro em caso de falha, que será pego pelo 'catch'.
                if(result && result.insertId) {
                    alert('Cadastro realizado com sucesso! Você será redirecionado para a tela de login.');
                    window.location.href = 'index.html';
                } else {
                    // Esta condição agora é menos provável de ser atingida, mas é mantida por segurança.
                    throw new Error('Não foi possível realizar o cadastro (resposta inesperada do servidor).');
                }
            } catch (error) {
                let userMessage = 'Ocorreu um erro inesperado.';
                
                if (error.message.includes("Duplicate entry")) {
                    // Verifica qual campo único causou o erro
                    if (error.message.includes("'usuarios.email'")) {
                        userMessage = 'Este e-mail já está cadastrado.';
                    } else if (error.message.includes("'usuarios.cpf'")) {
                        userMessage = 'Este CPF já está cadastrado.';
                    } else {
                        userMessage = 'Dados duplicados (email ou CPF).';
                    }
                } else if (error.message.includes("Falha na conexão")) {
                    // Esta mensagem vem do 'database.js' se o fetch falhar
                    userMessage = 'Não foi possível conectar ao servidor. Tente novamente mais tarde.';
                } else {
                    // Pega outras mensagens, como a do "else" acima ou outras falhas
                    userMessage = error.message;
                }

                errorMessage.textContent = 'Erro ao cadastrar: ' + userMessage;
                errorMessage.style.display = 'block';
                registerButton.textContent = 'Cadastrar';
                registerButton.disabled = false;
            }
        });
    </script>
</body>
</html>